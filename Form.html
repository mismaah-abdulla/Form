<html>
<head>
    <style>
    table, td {
        border: 1px solid black;
        border-collapse: collapse;
        
    }
    th {
        width: 200px;
        border: 1px solid black;
    }
    p {
        color:red;
    }
    
    button {
        text-align: right;
    }
    </style>
    <script>
            const NAME_MAX = 30;
            const NAME_MIN = 5;
            const VALID_EMAIL = /\S+@\S+\.\S+/;
            var rowCounter = 1
            function submitForm() {
                var name = document.getElementById("name");
                var email = document.getElementById("email");
                var password = document.getElementById("password");
                var date = document.getElementById("birthDate").value;
                
                if (checkEmpty(name.value) || checkEmpty(email.value) || checkEmpty(password.value) || checkEmpty(date)) {
                    document.getElementById("error").innerHTML = "Please fill all fields.";
                    return;
                }
                
                if (!isValidName(name.value)) {
                    document.getElementById("error").innerHTML = `Name should be between ${NAME_MAX} and ${NAME_MIN} characters.`;
                    return;
                }

                if (!isValidEmail(email)) {
                    document.getElementById("error").innerHTML = `Must be a valid email.`
                    return;
                }
                
                var inputDate = new Date(date);
                var userAge = getAge(inputDate);
                document.getElementById("tableRows").innerHTML += getRow(name.value, email.value, password.value, userAge, rowCounter);
                rowCounter++
                
                document.getElementById("error").innerHTML = "";
                clearField(name);
                clearField(email);
                clearField(password);
            }
            function getAge(birthDate) {
                var currentDate = new Date();
                var age = currentDate.getFullYear() - birthDate.getFullYear();
                return age;

            }
            function getRow(name, email, password, age, rowCounter){
                var encodedPassword = encodePassword(password);
                return `<tr id="row${rowCounter}">
                        <td class="nameCell">${name}</td>
                        <td class="emailCell">${email}</td>
                        <td class="passwordCell">
                            <span id="encodedPassword${rowCounter}">${encodedPassword}</span>
                            <button style="float: right;" id="decodePass" onmousedown="decodeEncodedPassword('${encodedPassword}', ${rowCounter})" onmouseup="hideDecodedPassword('${password}', ${rowCounter})">Decode</button>
                        </td>
                        <td>${age}</td>
                        <td><button style="float:left;" onclick="deleteRow(${rowCounter})">Delete row</button> <button style="float:right;" onclick="editRow(${rowCounter})">Edit row</button></td>
                        </tr>`;
            }
            
            // function allValidations(name, email, password, date){
            //     if (checkEmpty(name.value) || checkEmpty(email.value) || checkEmpty(password.value) || checkEmpty(date)) {
            //         document.getElementById("error").innerHTML = "Please fill all fields.";
            //         return;
            //     }

            //     if (!isValidName(name.value)) {
            //         document.getElementById("error").innerHTML = `Name should be between ${NAME_MAX} and ${NAME_MIN} characters.`;
            //         return;
            //     }

            //     if (!isValidEmail(email)) {
            //         document.getElementById("error").innerHTML = `Must be a valid email.`
            //         return;
            //     }
            // }

            function checkEmpty(field){
                return field === "";
            }

            function clearField(field){
                field.value = "";
            }

            function isValidName(name){
                return name.length < NAME_MAX && name.length > NAME_MIN;
            }

            function isValidEmail(email){
                return VALID_EMAIL.test(String(email.value).toLowerCase());
            }

            function showPassword(){
                document.getElementById("password").type = "text";
            }

            function hidePassword(){
                document.getElementById("password").type = "password";
            }

            function encodePassword(password){
                var encodedPassword = window.btoa(password);
                return encodedPassword;
            }

            function decodePassword(password){
                var decodedPassword = window.atob(password);
                return decodedPassword;
            }

            function decodeEncodedPassword(password, counter){
                document.getElementById(`encodedPassword${counter}`).innerHTML = decodePassword(password);
            }

            function hideDecodedPassword(password, counter){
                document.getElementById(`encodedPassword${counter}`).innerHTML = encodePassword(password);
            }

            function deleteRow(rowNumber){
                var row = document.getElementById(`row${rowNumber}`);
                row.parentNode.removeChild(row);
            }

            function editRow(rowNumber){
                returnRowContent(rowNumber);
                changeFormButtonsForEditing(rowNumber);
            }

            function returnRowContent(rowNumber){
                document.getElementById("name").value = document.querySelector(`#row${rowNumber} .nameCell`).innerHTML;
                document.getElementById("email").value = document.querySelector(`#row${rowNumber} .emailCell`).innerHTML;
                var password = document.getElementById(`encodedPassword${rowNumber}`).innerHTML;
                var decodedPassword = decodePassword(password);
                document.getElementById("password").value = decodedPassword;
            }

            function changeFormButtonsForEditing(rowNumber){
                document.getElementById("actionButtons").innerHTML = `<button onclick="updateForm(${rowNumber})">Update</button><button onclick="cancelUpdateForm()">Cancel</button>`
            }

            function updateForm(rowNumber){
                var name = document.getElementById("name");
                var email = document.getElementById("email");
                var password = document.getElementById("password");
                var date = document.getElementById("birthDate").value;

                if (checkEmpty(name.value) || checkEmpty(email.value) || checkEmpty(password.value) || checkEmpty(date)) {
                    document.getElementById("error").innerHTML = "Please fill all fields.";
                    return;
                }

                if (!isValidName(name.value)) {
                    document.getElementById("error").innerHTML = `Name should be between ${NAME_MAX} and ${NAME_MIN} characters.`;
                    return;
                }

                if (!isValidEmail(email)) {
                    document.getElementById("error").innerHTML = `Must be a valid email.`
                    return;
                }

                var inputDate = new Date(date);
                var userAge = getAge(inputDate);

                document.getElementById(`row${rowNumber}`).innerHTML = getRow(name.value, email.value, password.value, userAge, rowNumber);

                cancelUpdateForm();
            }

            function cancelUpdateForm(){
                clearField(document.getElementById("name"));
                clearField(document.getElementById("email"));
                clearField(document.getElementById("password"));
                document.getElementById("actionButtons").innerHTML = `<button onclick="submitForm()">Submit</button>`
                document.getElementById("error").innerHTML = "";
            }

            
    </script>
</head>
<body>
<h1 id="heading">Form</h1>
    <div>Name: 
    <input  id="name" type="text" value=""> </div><br>
    <div>Email: 
    <input id="email" type="text" value=""> </div><br>
    <div>Password:
    <input id="password" type="password" value=""> <button onmousedown="showPassword()" onmouseup="hidePassword()">Show</button></div><br> 
    <div>Date of birth: 
    <input id="birthDate" type="date" value=""></div><br>
    <div id="actionButtons"><button onclick="submitForm()">Submit</button></div>
    <br>
    <p id="error"></p>
    <br>
    <table >
        <thead>
            <tr>
                <th>Name</th>
                <th>Email</th>
                <th style="width: 250px;">Password</th>
                <th style="width: 100px;">Age</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="tableRows">

        </tbody>
        
        
    </table>

</body>
</html>